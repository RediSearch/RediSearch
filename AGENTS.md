# RediSearch Development Guide

RediSearch is a Redis module providing full-text search, secondary indexing, and vector similarity search. 
The primary development focus is porting C code from `src/` to Rust in `src/redisearch_rs/`.

## Build Commands

```bash
./build.sh                    # Full build (C + Rust)
./build.sh DEBUG=1            # Debug build
./build.sh FORCE              # Rebuild discarding previous artifacts
```

## Testing

```bash
./build.sh RUN_UNIT_TESTS                     # C/C++ unit tests
./build.sh RUN_UNIT_TESTS TEST=unit_test_name # Specific C/C++ unit tests
./build.sh RUN_PYTEST                         # Python behavioral tests
./build.sh RUN_PYTEST TEST=test_name          # Specific Python test
cargo nextest run                             # Rust tests, from `src/redisearch_rs/`
cargo +nightly miri test                      # Rust tests under `miri`, from `src/redisearch_rs/`
```

Run Rust tests from workspace root (`src/redisearch_rs/`):
```bash
# All Rust tests
cd src/redisearch_rs && cargo nextest run
# Rust tests for a specific crate
cd src/redisearch_rs && cargo nextest run -p <crate_name>
```

## Linting & Formatting

```bash
make lint                                 # Run clippy and cargo doc checks
make fmt                                  # Format all code
make fmt CHECK=1                          # Check formatting without changes
cd src/redisearch_rs && cargo license-fix # Add missing license headers
```

## Code Style

### Rust
- Edition 2024
- Document all `unsafe` blocks with `// SAFETY:` comments
- Use `#[expect(...)]` over `#[allow(...)]` for lint suppressions
- Use `tracing` macros for logging (debug!, info!, warn!, error!)

### C
- 2-space indentation, 100-char line limit
- Pointer alignment: left (`int* p;`)
- No trailing spaces

## Project Structure

```
src/                          # C source code (being ported)

src/redisearch_rs/            # Rust codebase
├── ...                       # New Rust-native functionality
├── ffi/                      # Rust bindings for C types and functions
├── headers/                  # Autogenerated C headers for Rust types and functions in *_ffi crates
├── c_entrypoint/             # FFI layer (C bindings for Rust types and functions)
│   └── *_ffi/                # Per-module FFI crates
│   └── redisearch_rs/        # Entrypoint for Rust-native functionality used by the C codebase
└── Cargo.toml                # Workspace root
```

## C to Rust Porting Patterns

### FFI Bridge Pattern
Each ported module has a corresponding `*_ffi` crate in `c_entrypoint/`:
```
src/redisearch_rs/
├── trie_rs/              # Pure Rust implementation
└── c_entrypoint/
    └── triemap_ffi/      # C-callable wrapper
```

## Common Workflows

### Porting a C Module
1. Create new Rust crate: `src/redisearch_rs/<module_name>/`
2. Implement Rust logic with comprehensive tests
3. Create FFI wrapper: `src/redisearch_rs/c_entrypoint/<module_name>_ffi/`
4. Add to workspace in `src/redisearch_rs/Cargo.toml`
5. Wire up C code to call Rust via FFI

### Adding Tests
- Unit tests: in the `tests/` directory.
  - Use inline `#[cfg(test)]` if and only if the test **must** use a private API
- Use `proptest` for property-based testing
- Use `insta` for snapshot testing

## Key Dependencies (Rust)
- `thiserror` - Error types

## License Header (Required)
```
/*
 * Copyright (c) 2006-Present, Redis Ltd.
 * All rights reserved.
 *
 * Licensed under your choice of the Redis Source Available License 2.0
 * (RSALv2); or (b) the Server Side Public License v1 (SSPLv1); or (c) the
 * GNU Affero General Public License v3 (AGPLv3).
*/
```
