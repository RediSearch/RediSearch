name: Flow Test Event

# Documentation: https://redislabs.atlassian.net/wiki/spaces/DX/pages/3967844669/RediSearch+CI+refactor

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      platform:
        type: choice
        options:
          - all
          - ubuntu:noble
          - ubuntu:jammy
          - ubuntu:focal
          - rockylinux:8
          - rockylinux:9
          - debian:bullseye
          - debian:bookworm
          - amazonlinux:2
          - amazonlinux:2023
          - mariner:2
          - azurelinux:3
          - alpine:3.19
          - macos
        description: 'Platform to test on. Use "all" to test on all platforms'
        default: all
      architecture:
        type: choice
        options:
          - all
          - x86_64
          - aarch64
        description: 'Architecture to test on. Use "all" to test on all architectures'
        default: all
      coordinator:
        description: 'Whether to run coordinator tests'
        type: boolean
        default: true
      standalone:
        description: 'Whether to run standalone tests'
        type: boolean
        default: true
      test-config:
        description: 'Test configuration environment variable (e.g. "CONFIG=tls" or "QUICK=1")'
        type: string
        default: QUICK=1
      redis-ref:
        description: 'Redis version to use (e.g. "7.2.3", "unstable"). Defaults to "unstable"'
        type: string
        default: unstable
      rejson:
        type: boolean
        default: true
        description: 'Enable tests with RedisJSON'
      rejson-branch:
        type: string
        default: master
        description: 'Branch to use when building RedisJSON for tests (default: master)'
      fail-fast:
        description: 'Whether to fail fast on first failure'
        type: boolean
        default: false

  # Trigger on push to specific branches (optional)
  # push:
  #   branches:
  #     - master
  #     - develop

  # Trigger on schedule (optional)
  # schedule:
  #   - cron: "0 2 * * *"  # Daily at 2 AM UTC

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  flow-test:
    uses: ./.github/workflows/flow-test.yml
    secrets: inherit
    with:
      platform: ${{ inputs.platform || 'all' }}
      architecture: ${{ inputs.architecture || 'all' }}
      coordinator: ${{ inputs.coordinator != false }}
      standalone: ${{ inputs.standalone != false }}
      test-config: ${{ inputs.test-config || 'QUICK=1' }}
      redis-ref: ${{ inputs.redis-ref || 'unstable' }}
      rejson: ${{ inputs.rejson != false }}
      rejson-branch: ${{ inputs.rejson-branch || 'master' }}
      fail-fast: ${{ inputs.fail-fast == true }}
