name: Get Latest Release Tag of a GitHub Repository

on:
  workflow_call:
    inputs:
      repo:
        description: "Repository name in the format of owner/repo"
        type: string
        required: true
      prefix:
        description: "Prefix to filter tags, for getting latest release of a specific version"
        type: string
    outputs:
      tag: # Latest release tag
        description: "Latest release tag"
        value: ${{ jobs.get-tag.outputs.tag }}


jobs:
  get-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.latest.outputs.tag || steps.with-prefix.outputs.tag }}
    steps:
      - name: Get Latest Release Tag
        id: latest
        if: ${{ !inputs.prefix }}
        run: |
          echo "tag=$(curl -sL \
                           -H "Accept: application/vnd.github+json" \
                           -H "X-GitHub-Api-Version: 2022-11-28" \
                           https://api.github.com/repos/${{ inputs.repo }}/releases/latest | \
                      jq -r '.tag_name')" >> $GITHUB_OUTPUT
      - name: Get Latest Release Tag with Prefix
        id: with-prefix
        if: ${{ inputs.prefix }}
        run: |
          echo "tag=$(curl -sL \
                           -H "Accept: application/vnd.github+json" \
                           -H "X-GitHub-Api-Version: 2022-11-28" \
                           https://api.github.com/repos/${{ inputs.repo }}/releases | \
                      jq -r '.[] | select(.tag_name | startswith("${{ inputs.prefix }}")) | .tag_name' | \
                      sort -V | tail -1)" >> $GITHUB_OUTPUT
