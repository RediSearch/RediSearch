name: Get Single Configuration

# This workflow gets configuration for a single instance
# Used by task-test and task-build-artifact to get their specific configuration

on:
  workflow_call:
    inputs:
      platform:
        description: 'Platform name (e.g., ubuntu:noble, macos, sanitizer, coverage)'
        type: string
        required: true
      architecture:
        description: 'Architecture (x86_64, aarch64)'
        type: string
        required: true
    outputs:
      config:
        description: "Configuration for the specific platform and architecture as JSON"
        value: ${{ jobs.get-config.outputs.config }}

jobs:
  get-config:
    runs-on: ${{ vars.RUNS_ON || 'ubuntu-latest' }}
    outputs:
      config: ${{ steps.get-config.outputs.config }}
    steps:
      - name: Get configuration for platform and architecture
        id: get-config
        shell: python
        run: |
          import json
          import os
          import sys

          platform = "${{ inputs.platform }}"
          architecture = "${{ inputs.architecture }}"

          print(f"Getting configuration for platform: {platform}, architecture: {architecture}")

          # Initialize default values
          config = {
              'env': '',
              'container': '',
              'pre-steps-script': '',
              'name': ''
          }

          # Handle special platforms first
          if platform == "macos":
              if architecture == "x86_64":
                  config.update({
                      'env': 'MACOS=1',
                      'name': 'macOS x86_64'
                  })
              elif architecture == "aarch64":
                  config.update({
                      'env': 'MACOS=1',
                      'name': 'macOS ARM64'
                  })
              else:
                  print(f"Error: Unsupported architecture '{architecture}' for macOS")
                  sys.exit(1)

          elif platform == "sanitizer":
              if architecture == "x86_64":
                  config.update({
                      'env': 'SAN=address',
                      'container': 'redisfab/rmbuilder:6.2.7-x64-bullseye',
                      'pre-steps-script': './deps/readies/bin/getpy3',
                      'san': 'address',
                      'name': 'Sanitizer x86_64'
                  })
              else:
                  print(f"Error: Sanitizer only supports x86_64 architecture")
                  sys.exit(1)

          elif platform == "coverage":
              if architecture == "x86_64":
                  config.update({
                      'env': 'COV=1',
                      'container': 'redisfab/rmbuilder:6.2.7-x64-bullseye',
                      'pre-steps-script': './deps/readies/bin/getpy3',
                      'coverage': '1',
                      'name': 'Coverage x86_64'
                  })
              else:
                  print(f"Error: Coverage only supports x86_64 architecture")
                  sys.exit(1)

          else:
              # Handle Linux platforms
              platform_configs = {
                  "ubuntu:noble": {
                      "x86_64": {
                          'env': 'ubuntu-latest',
                          'container': 'ubuntu:noble',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Ubuntu Noble x86_64'
                      },
                      "aarch64": {
                          'env': 'ubuntu-latest',
                          'container': 'ubuntu:noble',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Ubuntu Noble ARM64'
                      }
                  },
                  "ubuntu:jammy": {
                      "x86_64": {
                          'env': 'ubuntu-latest',
                          'container': 'ubuntu:jammy',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Ubuntu Jammy x86_64'
                      },
                      "aarch64": {
                          'env': 'ubuntu-latest',
                          'container': 'ubuntu:jammy',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Ubuntu Jammy ARM64'
                      }
                  },
                  "ubuntu:focal": {
                      "x86_64": {
                          'env': 'ubuntu-latest',
                          'container': 'ubuntu:focal',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Ubuntu Focal x86_64'
                      },
                      "aarch64": {
                          'env': 'ubuntu-latest',
                          'container': 'ubuntu:focal',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Ubuntu Focal ARM64'
                      }
                  },
                  "rockylinux:8": {
                      "x86_64": {
                          'env': 'ubuntu-latest',
                          'container': 'rockylinux:8',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Rocky Linux 8 x86_64'
                      },
                      "aarch64": {
                          'env': 'ubuntu-latest',
                          'container': 'rockylinux:8',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Rocky Linux 8 ARM64'
                      }
                  },
                  "rockylinux:9": {
                      "x86_64": {
                          'env': 'ubuntu-latest',
                          'container': 'rockylinux:9',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Rocky Linux 9 x86_64'
                      },
                      "aarch64": {
                          'env': 'ubuntu-latest',
                          'container': 'rockylinux:9',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Rocky Linux 9 ARM64'
                      }
                  },
                  "amazonlinux:2": {
                      "x86_64": {
                          'env': 'ubuntu-latest',
                          'container': 'amazonlinux:2',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Amazon Linux 2 x86_64'
                      },
                      "aarch64": {
                          'env': 'ubuntu-latest',
                          'container': 'amazonlinux:2',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Amazon Linux 2 ARM64'
                      }
                  },
                  "alpine:3": {
                      "x86_64": {
                          'env': 'ubuntu-latest',
                          'container': 'alpine:3',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Alpine 3 x86_64'
                      },
                      "aarch64": {
                          'env': 'ubuntu-latest',
                          'container': 'alpine:3',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Alpine 3 ARM64'
                      }
                  },
                  "debian:bullseye": {
                      "x86_64": {
                          'env': 'ubuntu-latest',
                          'container': 'gcc:11-bullseye',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Debian Bullseye x86_64'
                      },
                      "aarch64": {
                          'env': 'ubuntu-latest',
                          'container': 'gcc:11-bullseye',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Debian Bullseye ARM64'
                      }
                  },
                  "debian:bookworm": {
                      "x86_64": {
                          'env': 'ubuntu-latest',
                          'container': 'gcc:12-bookworm',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Debian Bookworm x86_64'
                      },
                      "aarch64": {
                          'env': 'ubuntu-latest',
                          'container': 'gcc:12-bookworm',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Debian Bookworm ARM64'
                      }
                  },
                  "amazonlinux:2023": {
                      "x86_64": {
                          'env': 'ubuntu-latest',
                          'container': 'amazonlinux:2023',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Amazon Linux 2023 x86_64'
                      },
                      "aarch64": {
                          'env': 'ubuntu-latest',
                          'container': 'amazonlinux:2023',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Amazon Linux 2023 ARM64'
                      }
                  },
                  "mariner:2": {
                      "x86_64": {
                          'env': 'ubuntu-latest',
                          'container': 'mcr.microsoft.com/cbl-mariner/base/core:2.0',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Mariner 2 x86_64'
                      },
                      "aarch64": {
                          'env': 'ubuntu-latest',
                          'container': 'mcr.microsoft.com/cbl-mariner/base/core:2.0',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Mariner 2 ARM64'
                      }
                  },
                  "azurelinux:3": {
                      "x86_64": {
                          'env': 'ubuntu-latest',
                          'container': 'mcr.microsoft.com/azurelinux/base/core:3.0',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Azure Linux 3 x86_64'
                      },
                      "aarch64": {
                          'env': 'ubuntu-latest',
                          'container': 'mcr.microsoft.com/azurelinux/base/core:3.0',
                          'pre-steps-script': './deps/readies/bin/getpy3',
                          'name': 'Azure Linux 3 ARM64'
                      }
                  }
              }

              if platform in platform_configs:
                  if architecture in platform_configs[platform]:
                      config.update(platform_configs[platform][architecture])
                  else:
                      print(f"Error: Unsupported architecture '{architecture}' for {platform}")
                      sys.exit(1)
              else:
                  print(f"Error: Unsupported platform '{platform}'")
                  sys.exit(1)

          # Output the configuration as JSON
          config_json = json.dumps(config)
          print(f"Generated configuration: {config_json}")

          # Write to GitHub output
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'config={config_json}\n')