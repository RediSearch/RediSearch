name: Trigger Build and Upload Artifacts for Environments

on:
  workflow_dispatch:
    inputs:
      platform:
        type: choice
        options:
          - all
          - ubuntu:noble
          - ubuntu:jammy
          - ubuntu:focal
          - rockylinux:8
          - rockylinux:9
          - debian:bullseye
          - debian:bookworm
          - amazonlinux:2
          - amazonlinux:2023
          - mariner:2
          - azurelinux:3
          - alpine:3
          - macos
        description: 'Platform to build on. Use "all" to build on all'
        default: all
      architecture:
        type: choice
        options:
          - all
          - x86_64
          - aarch64
        description: 'Architecture to build on. Use "all" to build on all'
        default: all
      force_beta:
        type: boolean
        description: 'Force beta version generation even for non-master branches (for testing)'
        default: false
  workflow_call:
    inputs:
      platform:
        type: string
        default: all
      architecture:
        type: string
        default: all
      force_beta:
        type: boolean
        default: false

jobs:
  setup:
    # Sets SHA and Validates the reference Input (branch or tag)
    runs-on: ${{ vars.RUNS_ON || 'ubuntu-latest' }}
    outputs:
      sha: ${{ steps.set-sha.outputs.sha }}
      redis-ref: ${{ steps.get-redis.outputs.tag }}
      beta-version: ${{ steps.beta-version.outputs.BETA_VERSION }}
    steps:
      - uses: actions/checkout@v4
      - id: set-sha
        run: echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      - id: get-redis
        shell: bash -l -eo pipefail {0}
        run: |
          # TAG=$(curl -sL --retry 5 https://api.github.com/repos/redis/redis/releases/latest | jq -er '.tag_name') && \
          # echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "tag=unstable" >> $GITHUB_OUTPUT
      - name: Generate Beta Version unique identifier
        id: beta-version
        run: |
          # Generate beta version for master branch builds or when force_beta is enabled
          BRANCH_NAME="${{ github.ref_name }}"
          FORCE_BETA="${{ inputs.force_beta }}"
          echo "Building from branch: $BRANCH_NAME"
          echo "Force beta enabled: $FORCE_BETA"

          if [[ "$BRANCH_NAME" == "master" ]] || [[ "$FORCE_BETA" == "true" ]]; then
            # Generate timestamp at workflow start for consistent beta versioning across all builds
            TIMESTAMP=$(date -u +"%Y%m%d.%H%M%S")
            # Add workflow number to ensure the version is unique (if multiple workflows started at the same time)
            WORKFLOW_NUM=${{ github.run_number }}
            BETA_VERSION="99.99.99.${TIMESTAMP}.${WORKFLOW_NUM}"
            echo "BETA_VERSION=$BETA_VERSION" >> $GITHUB_OUTPUT
            if [[ "$BRANCH_NAME" == "master" ]]; then
              echo "Master branch detected, generating beta version: $BETA_VERSION"
            else
              echo "Force beta enabled for branch $BRANCH_NAME, generating beta version: $BETA_VERSION"
            fi
          else
            echo "Non-master branch detected ($BRANCH_NAME) and force_beta not enabled, no beta version generated"
          fi
      - name: Validate Reference
        shell: python
        run: |
          from re import fullmatch
          ref = '${{ github.ref_name }}'
          if bool(fullmatch(r'[0-9]+\.[0-9]+', ref)) or ref == 'master': # e.g. 2.8, 2.10, master
            if '${{ inputs.architecture }}' != 'all' or '${{ inputs.platform }}' != 'all':
              print("::error title=Invalid Request::"
                    "You can only build all configurations for master or a release branch")
              exit(1)

  build-unified:
    name: ${{ matrix.platform }} (${{ matrix.architecture }})
    needs: [setup]
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux platforms - x86_64
          - platform: ubuntu:noble
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["ubuntu:noble", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: ubuntu:jammy
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["ubuntu:jammy", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: ubuntu:focal
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["ubuntu:focal", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: ubuntu:bionic
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["ubuntu:bionic", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: rockylinux:8
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["rockylinux:8", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: rockylinux:9
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["rockylinux:9", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: debian:bullseye
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["debian:bullseye", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: debian:bookworm
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["debian:bookworm", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: amazonlinux:2
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["amazonlinux:2", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: amazonlinux:2023
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["amazonlinux:2023", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: mariner:2
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["mariner:2", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: azurelinux:3
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["azurelinux:3", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: alpine:3
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["alpine:3", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          # Linux platforms - ARM64
          - platform: ubuntu:noble
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["ubuntu:noble", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: ubuntu:jammy
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["ubuntu:jammy", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: ubuntu:focal
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["ubuntu:focal", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: ubuntu:bionic
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["ubuntu:bionic", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: rockylinux:8
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["rockylinux:8", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: rockylinux:9
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["rockylinux:9", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: debian:bullseye
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["debian:bullseye", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: debian:bookworm
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["debian:bookworm", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: amazonlinux:2
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["amazonlinux:2", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: amazonlinux:2023
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["amazonlinux:2023", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: mariner:2
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["mariner:2", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: azurelinux:3
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["azurelinux:3", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: alpine:3
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["alpine:3", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          # macOS platforms
          - platform: macos
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["macos", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: macos
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["macos", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
    uses: ./.github/workflows/task-build-artifacts-with-config.yml
    secrets: inherit
    with:
      platform: ${{ matrix.platform }}
      architecture: ${{ matrix.architecture }}
      sha: ${{ needs.setup.outputs.sha }}
      redis-ref: ${{ needs.setup.outputs.redis-ref }}
      beta-version: ${{ needs.setup.outputs.beta-version }}
      skip-condition: ${{ matrix.skip-condition || 'false' }}
