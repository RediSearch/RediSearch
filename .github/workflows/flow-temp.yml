name: temporary testing

on: [push]


env:
  ALL_IMAGES: "['ubuntu:jammy',
                'ubuntu:bionic',
                'centos:7',
                'rockylinux:8',
                'rockylinux:9',
                'debian:bullseye',
                'amazonlinux:2']"

jobs:
  get-required-envs:
    runs-on: ubuntu-latest
    outputs:
      platforms: ${{ steps.get_platforms.outputs.platforms }}
      include: ${{ steps.get_platforms.outputs.include }}
    steps:
      - name: Get platform
        id: get_platforms
        shell: python
        run: |
          import os

          platforms = 'all'
          include = []

          if platforms == 'all':
            platforms = ${{ env.ALL_IMAGES }}
          else:
            platforms = [platforms]

          # Special cases:

          # amazonlinux:2 needs pre-checkout dependencies
          if platforms.count('amazonlinux:2') > 0:
            include.append({'OS': 'amazonlinux:2', 'pre-deps': "yum install -y tar"})

          # Serialize the platforms to a string
          with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
            print(f'platforms={platforms}', file=fh)
            print(f'include={include}', file=fh)
            # for case in include:
            #   print(f

  test-matrix:
    needs: get-required-envs
    runs-on: ubuntu-latest
    strategy:
      matrix:
        OS: ${{ fromJson(needs.get-required-envs.outputs.platforms) }}
        include: ${{ fromJson(needs.get-required-envs.outputs.include) }}
    steps:
      - name: Print
        run: |
          echo "OS: ${{ matrix.OS }}"
          echo "msg: ${{ matrix.pre-deps || 'none' }}"
