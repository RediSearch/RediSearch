name: Test Flow

# Documentation: https://redislabs.atlassian.net/wiki/spaces/DX/pages/3967844669/RediSearch+CI+refactor


on:
  workflow_call:
    inputs:
      platform:
        type: string
        default: all
      architecture:
        type: string
        default: all
      test-config:
        description: 'Test configuration environment variable (e.g. "CONFIG=tls" or "QUICK=1")'
        type: string
      coordinator:
        type: boolean
        default: true
      standalone:
        type: boolean
        default: true
      redis-ref:
        type: string
      rejson:
        type: boolean
        default: true
        description: 'Enable tests with RedisJSON'
      rejson-branch:
        type: string
        default: master
        description: 'Branch to use when building RedisJSON for tests'
      fail-fast:
        type: boolean
        default: true # Default to true on workflow call (as in matrix, and unlike manual trigger)

  workflow_dispatch:
    inputs:
      platform:
        type: choice
        options:
          - all
          - ubuntu:noble
          - ubuntu:jammy
          - ubuntu:focal
          - rockylinux:8
          - rockylinux:9
          - debian:bullseye
          - debian:bookworm
          - amazonlinux:2
          - amazonlinux:2023
          - mariner:2
          - azurelinux:3
          - alpine:3
          - macos
        description: 'Platform to test on. Use "all" to test on all platforms'
        default: all
      architecture:
        type: choice
        options:
          - all
          - x86_64
          - aarch64
        description: 'Architecture to test on. Use "all" to test on all architectures'
        default: all
      coordinator:
        description: 'Whether to run coordinator tests'
        type: boolean
        default: true
      standalone:
        description: 'Whether to run standalone tests'
        type: boolean
        default: true
      test-config:
        description: 'Test configuration environment variable (e.g. "CONFIG=tls" or "QUICK=1")'
        type: string
      redis-ref:
        description: 'Redis version to use (e.g. "7.2.3", "unstable"). Defaults to "unstable"'
        type: string
      rejson:
        type: boolean
        default: true
        description: 'Enable tests with RedisJSON'
      rejson-branch:
        type: string
        default: master
        description: 'Branch to use when building RedisJSON for tests (default: master)'
      fail-fast:
        description: 'Whether to fail fast on first failure'
        type: boolean
        default: false # Default to false on manual trigger

jobs:
  # Unified test matrix - includes Linux and macOS platforms
  test-matrix:
    name: ${{ matrix.platform }} (${{ matrix.architecture }})
    strategy:
      matrix:
        include:
          # Ubuntu platforms
          - platform: ubuntu:noble
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["ubuntu:noble", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: ubuntu:noble
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["ubuntu:noble", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: ubuntu:jammy
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["ubuntu:jammy", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: ubuntu:jammy
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["ubuntu:jammy", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: ubuntu:focal
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["ubuntu:focal", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: ubuntu:focal
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["ubuntu:focal", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: rockylinux:8
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["rockylinux:8", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: rockylinux:8
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["rockylinux:8", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: rockylinux:9
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["rockylinux:9", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: rockylinux:9
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["rockylinux:9", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: amazonlinux:2
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["amazonlinux:2", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: amazonlinux:2023
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["amazonlinux:2023", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: amazonlinux:2023
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["amazonlinux:2023", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: debian:bullseye
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["debian:bullseye", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: debian:bullseye
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["debian:bullseye", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: debian:bookworm
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["debian:bookworm", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: debian:bookworm
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["debian:bookworm", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: mariner:2
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["mariner:2", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: azurelinux:3
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["azurelinux:3", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: azurelinux:3
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["azurelinux:3", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          - platform: alpine:3
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["alpine:3", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: alpine:3
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["alpine:3", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
          # macOS platforms
          - platform: macos
            architecture: x86_64
            skip-condition: ${{ !contains(fromJson('["macos", "all"]'), inputs.platform) || !contains(fromJson('["x86_64", "all"]'), inputs.architecture) }}
          - platform: macos
            architecture: aarch64
            skip-condition: ${{ !contains(fromJson('["macos", "all"]'), inputs.platform) || !contains(fromJson('["aarch64", "all"]'), inputs.architecture) }}
      fail-fast: ${{ inputs.fail-fast }}
    uses: ./.github/workflows/task-test-with-config.yml
    secrets: inherit
    with:
      platform: ${{ matrix.platform }}
      architecture: ${{ matrix.architecture }}
      get-redis: ${{ inputs.redis-ref }}
      rejson: ${{ inputs.rejson }}
      rejson-branch: ${{ inputs.rejson-branch }}
      coordinator: ${{ inputs.coordinator }}
      standalone: ${{ inputs.standalone }}
      test-config: ${{ inputs.test-config || 'QUICK=1' }}
      skip-condition: ${{ matrix.skip-condition || 'false' }}
