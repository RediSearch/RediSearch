name: Build on Platforms

# Documentation: https://redislabs.atlassian.net/wiki/spaces/DX/pages/3967844669/RediSearch+CI+refactor


on:
  workflow_call:
    inputs:
      platform:
        type: string
        default: all
      architecture:
        type: string
        default: all
      job-test-config:
        description: 'JSON mapping of job-type to test-config (e.g. ''{"test": "QUICK=1", "coverage": "", "sanitize": ""}''). Use empty string for full tests.'
        type: string
        default: '{"test": "QUICK=1", "coverage": "QUICK=1", "sanitize": "QUICK=1"}'
      redis-ref:
        type: string
      rejson-branch:
        type: string
        default: master
        description: 'Branch to use when building RedisJSON for tests'
      options:
        type: string
        default: coordinator,standalone,rejson,fail-fast
        description: 'Comma-separated list of options: coordinator, standalone, rejson, fail-fast, coverage, sanitize'

  workflow_dispatch:
    inputs:
      platform:
        type: choice
        options:
          - all
          - ubuntu:noble
          - ubuntu:jammy
          - ubuntu:focal
          - rockylinux:8
          - rockylinux:9
          - debian:bullseye
          - debian:bookworm
          - amazonlinux:2
          - amazonlinux:2023
          - mariner:2
          - azurelinux:3
          - alpine:3.22
          - macos
        description: 'Platform to test on. Use "all" to test on all platforms'
        default: all
      architecture:
        type: choice
        options:
          - all
          - x86_64
          - aarch64
        description: 'Architecture to test on. Use "all" to test on all architectures'
        default: all
      test-config:
        description: Test configuration environment variable (e.g. "CONFIG=tls" or "QUICK=1")
        type: string
        default: QUICK=1
      redis-ref:
        description: 'Redis version to use (e.g. "7.2.3", "unstable"). Defaults to "unstable"'
        type: string
      rejson-branch:
        type: string
        default: master
        description: 'Branch to use when building RedisJSON for tests (default: master)'
      standalone:
        description: 'Whether to run standalone tests'
        type: boolean
        default: true
      cluster:
        description: 'Whether to run tests in cluster mode'
        type: boolean
        default: true
      RedisJSON:
        description: 'Whether to include RedisJSON in the tests'
        type: boolean
        default: true
      fail-fast:
        description: 'Whether to fail fast on test failures'
        type: boolean
        default: true

jobs:
  generate-matrix:
    uses: ./.github/workflows/generate-matrix.yml
    with:
      platform: ${{ inputs.platform }}
      architecture: ${{ inputs.architecture }}
      include-coverage: ${{ contains(inputs.options, 'coverage') }}
      include-sanitize: ${{ contains(inputs.options, 'sanitize') }}

  # Unified test matrix - includes Linux and macOS platforms, plus optional coverage and sanitize
  test-matrix:
    name: ${{ (matrix.job-type || 'test') == 'test' && format('{0} ({1})', matrix.platform, matrix.architecture) || format('{0} ({1})', (matrix.job-type || 'test'), matrix.architecture) }}
    needs: [generate-matrix]
    if: ${{ needs.generate-matrix.outputs.has-jobs == 'true' }}
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
      fail-fast: ${{ contains(inputs.options, 'fail-fast') || inputs.fail-fast }}
    uses: ./.github/workflows/task-test.yml
    secrets: inherit
    with:
      platform: ${{ matrix.platform }}
      architecture: ${{ matrix.architecture }}
      get-redis: ${{ inputs.redis-ref }}
      rejson: ${{ contains(inputs.options, 'rejson') || inputs.RedisJSON }}
      rejson-branch: ${{ inputs.rejson-branch }}
      coordinator: ${{ contains(inputs.options, 'coordinator') || inputs.cluster }}
      standalone: ${{ contains(inputs.options, 'standalone') || inputs.standalone }}
      test-config: ${{ fromJson(inputs.job-test-config || '{"test":""}')[(matrix.job-type || 'test')] || inputs.test-config }}
      coverage: ${{ (matrix.job-type || 'test') == 'coverage' }}
      san: ${{ (matrix.job-type || 'test') == 'sanitize' && 'address' || '' }}
      fail-fast: ${{ contains(inputs.options, 'fail-fast') || inputs.fail-fast }}
