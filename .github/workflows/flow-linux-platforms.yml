name: Build on Linux Platforms

# Documentation: https://redislabs.atlassian.net/wiki/spaces/DX/pages/3967844669/RediSearch+CI+refactor


on:
  workflow_call:
    inputs:
      platform:
        type: string
        default: all
      architecture:
        type: string
        default: all
      test-config:
        description: 'Test configuration environment variable (e.g. "CONFIG=tls" or "QUICK=1")'
        type: string
      coordinator:
        type: boolean
        default: true
      standalone:
        type: boolean
        default: true
      redis-ref:
        type: string
      fail-fast:
        type: boolean
        default: true # Default to true on workflow call (as in matrix, and unlike manual trigger)
  workflow_dispatch:
    inputs:
      platform:
        type: choice
        options:
          - all
          - ubuntu:jammy
          - ubuntu:focal
          - ubuntu:bionic
          - ubuntu:xenial
          - centos:7
          - rockylinux:8
          # - rockylinux:9
          - debian:bullseye
          - amazonlinux:2
          - mariner:2
        description: 'Platform to build on. Use "all" to build on all'
        default: all
      architecture:
        type: choice
        options:
          - all
          - x86_64
          - aarch64
        description: 'Architecture to build on. Use "all" to build on all'
        default: all
      coordinator:
        description: 'Whether to run coordinator tests'
        type: boolean
        default: true
      standalone:
        description: 'Whether to run standalone tests'
        type: boolean
        default: true
      test-config:
        description: 'Test configuration environment variable (e.g. "CONFIG=tls" or "QUICK=1")'
        type: string
      redis-ref:
        description: 'Redis version to use (e.g. "7.2.3", "unstable"). Defaults to "unstable"'
        type: string
      fail-fast:
        description: 'Whether to fail fast on first failure'
        type: boolean
        default: false # Default to false on manual trigger

jobs:
  get-required-envs:
    runs-on: ubuntu-latest
    steps:
      - run: echo "REDIS_REF=${{ github.event.inputs.redis-ref || 'unstable' }}"

  linux-matrix-x86_64:
    runs-on: ubuntu-latest
    steps:
      - run: echo "x86_64"
      - if: inputs.redis-ref == '6.0.20'
        run: sleep 10 ; exit 1
      # - run: sleep 60

  linux-matrix-aarch64:
    runs-on: ubuntu-latest
    steps:
      - run: echo "aarch64"
