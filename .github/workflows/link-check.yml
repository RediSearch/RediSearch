name: Link Check

on:
  # Allow manual triggering
  workflow_dispatch:

  # Run on PRs that modify markdown files or when labeled
  pull_request:
    types: [opened, synchronize, labeled]
    paths:
      - '**.md'
      - 'scripts/check_links.py'
      - 'scripts/requirements-linkcheck.txt'
      - '.github/workflows/link-check.yml'

jobs:
  link-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Run if files changed OR if 'check-links' label is added
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.action != 'labeled' ||
      contains(github.event.label.name, 'check-links')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip uv
        uv pip install --system -r scripts/requirements-linkcheck.txt

    - name: Check links in documentation
      run: |
        python scripts/check_links.py . \
          --timeout 15 \
          --max-workers 5 \
          --delay 0.2
      
    - name: Upload results on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: link-check-results
        path: |
          link-check-*.log
        retention-days: 7
        
    - name: Comment on PR
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸ”— Link Check Failed

            Some links in the modified Markdown files are broken or unreachable.

            Please check the workflow logs for details and fix the broken links.

            You can run the link checker locally with:
            \`\`\`bash
            python scripts/check_links.py .
            \`\`\`

            **Note:** This check validates both URL accessibility and anchor existence.`
          });
