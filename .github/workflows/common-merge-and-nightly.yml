name: Common Flow for Nightly and PRs' Merge Queue

# Documentation: https://redislabs.atlassian.net/wiki/spaces/DX/pages/3967844669/RediSearch+CI+refactor

on:
  workflow_call:
    inputs: # TODO: Use these inputs for getting the correct branch/version of Redis and RedisJSON for the flow
      redis-ref:
        required: true
        type: string
      json-ref:
        required: true
        type: string

env:
  LINUX_PLATFORMS: |
    ubuntu:jammy
    ubuntu:bionic
    centos:7
    rockylinux:8
    rockylinux:9
    debian:bullseye
    amazonlinux:2

jobs:
  # run-tests-on-linux:
  #   strategy:
  #     matrix:
  #       standalone:  [true] # Set a default value
  #       coordinator: [true] # Set a default value
  #       test-config: # configurations for both standalone and coordinator
  #         - concurrent_write
  #         - max_unsorted
  #         - union_iterator_heap
  #         - raw_docid
  #         - dialect_2
  #       include: # spacial configurations
  #         - test-config: global_password
  #           standalone:  false
  #         - test-config: safemode
  #           standalone:  false
  #         - test-config: tls
  #           standalone:  false

  #   uses: ./.github/workflows/flow-linux-platforms.yml
  #   secrets: inherit
  #   with:
  #     platform: all
  #     architecture: all
  #     test-config: CONFIG=${{ matrix.test-config }}
  #     standalone: ${{ matrix.standalone }}
  #     coordinator: ${{ matrix.coordinator }}

  # TODO: Remove this two steps and use the one above, once github actions supports
  #       workflow call depth of >= 5 (currently it's 4).
  #       In the meantime, we have to re-write the `flow-linux-platforms.yml` flow here
  #       and maintain the list of platforms from the `flow-linux-platforms.yml` file here as well.
  run-tests-on-linux-x86_64:
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ github.env.LINUX_PLATFORMS }}
        standalone:  [true] # Set a default value
        coordinator: [true] # Set a default value
        test-config: # configurations for both standalone and coordinator
          - concurrent_write
          - max_unsorted
          - union_iterator_heap
          - raw_docid
          - dialect_2
        include: # spacial configurations
          - test-config: global_password
            standalone:  false
          - test-config: safemode
            standalone:  false
          - test-config: tls
            standalone:  false
    uses: ./.github/workflows/common-flow-container.yml
    secrets: inherit
    with:
      container: ${{ matrix.platform }}
      test-config: CONFIG=${{ matrix.test-config }}
      standalone: ${{ matrix.standalone }}
      coordinator: ${{ matrix.coordinator }}

  run-tests-on-linux-arm64:
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ github.env.LINUX_PLATFORMS }}
        standalone:  [true] # Set a default value
        coordinator: [true] # Set a default value
        test-config: # configurations for both standalone and coordinator
          - concurrent_write
          - max_unsorted
          - union_iterator_heap
          - raw_docid
          - dialect_2
        include: # spacial configurations
          - test-config: global_password
            standalone:  false
          - test-config: safemode
            standalone:  false
          - test-config: tls
            standalone:  false

    uses: ./.github/workflows/flow-self-hosted-arm.yml
    secrets: inherit
    with:
      container: ${{ matrix.platform }}
      test-config: CONFIG=${{ matrix.test-config }}
      standalone: ${{ matrix.standalone }}
      coordinator: ${{ matrix.coordinator }}

  run-tests-on-macos:
    strategy:
      matrix:
        standalone:  [true] # Set a default value
        coordinator: [true] # Set a default value
        test-config: # configurations for both standalone and coordinator
          - concurrent_write
          - max_unsorted
          - union_iterator_heap
          - raw_docid
          - dialect_2
        include: # spacial configurations
          - test-config: global_password
            standalone:  false
          - test-config: safemode
            standalone:  false
          - test-config: tls
            standalone:  false

    uses: ./.github/workflows/flow-macos.yml
    secrets: inherit
    with:
      test-config: CONFIG=${{ matrix.test-config }}
      standalone: ${{ matrix.standalone }}
      coordinator: ${{ matrix.coordinator }}

  coverage:
    uses: ./.github/workflows/flow-coverage.yml
    secrets: inherit

  sanitize:
    uses: ./.github/workflows/flow-sanitizer.yml
    secrets: inherit
    with:
      flow-config: '' # full sanitization
