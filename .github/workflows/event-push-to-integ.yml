name: Push to Master or Version Branch

# Documentation: https://redislabs.atlassian.net/wiki/spaces/DX/pages/3967844669/RediSearch+CI+refactor

on:
  push:
    branches:
      - master
      - '[0-9]+.[0-9]+'

jobs:
  deploy-snapshot:
    concurrency:
      group: snapshot-${{ github.event.base_ref }} # Snapshot guard for each branch
      cancel-in-progress: true # Cancel previous snapshot builds. Only the latest snapshot build will be kept.
    secrets: inherit
    uses: ./.github/workflows/flow-build-artifacts.yml

  benchmark-needed:
    runs-on: ubuntu-latest
    outputs:
      BENCHMARK_NEEDED: ${{ steps.check-benchmarks.outputs.any_modified }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # required for changed-files action to work
      - name: Check if benchmarks were changed
        id: check-benchmarks
        uses: tj-actions/changed-files@v44
        with: # Only run on changes to these paths (code, deps, and benchmarks related changes)
          files: |
            src/**
            coord/src/**
            deps/**
            tests/benchmarks/**
            .github/workflows/benchmark-*.yml
            **/CMakeLists.txt
            **/Makefile

  benchmark:
    needs: benchmark-needed
    if: ${{ needs.benchmark-needed.outputs.BENCHMARK_NEEDED == 'true' }}
    uses: ./.github/workflows/benchmark-runner.yml
    secrets: inherit
