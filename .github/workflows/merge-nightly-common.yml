name: Common Flow for Nightly and PRs

on:
  workflow_call:
    inputs:
      redis-ref:
        required: true
        type: string
      json-ref:
        required: true
        type: string

jobs:
  run-tests-on-linux:
    strategy:
      matrix:
        include:
          - test-config: concurrent_write
            standalone:  true
            coordinator: true
          - test-config: max_unsorted
            standalone:  true
            coordinator: true
          - test-config: union_iterator_heap
            standalone:  true
            coordinator: true
          - test-config: raw_docid
            standalone:  true
            coordinator: true
          - test-config: dialect_2
            standalone:  true
            coordinator: true

          - test-config: global_password
            standalone:  false
            coordinator: true
          - test-config: safemode
            standalone:  false
            coordinator: true
          - test-config: tls
            standalone:  false
            coordinator: true

    uses: ./.github/workflows/flow-linux-platforms.yml
    secrets: inherit
    with:
      platform: all
      architecture: all
      test-config: CONFIG=${{ matrix.test-config }}
      standalone: ${{ matrix.standalone }}
      coordinator: ${{ matrix.coordinator }}

  run-tests-on-macos:
    strategy:
      matrix:
        include:
          - test-config: concurrent_write
            standalone:  true
            coordinator: true
          - test-config: max_unsorted
            standalone:  true
            coordinator: true
          - test-config: union_iterator_heap
            standalone:  true
            coordinator: true
          - test-config: raw_docid
            standalone:  true
            coordinator: true
          - test-config: dialect_2
            standalone:  true
            coordinator: true

          - test-config: global_password
            standalone:  false
            coordinator: true
          - test-config: safemode
            standalone:  false
            coordinator: true
          - test-config: tls
            standalone:  false
            coordinator: true

    uses: ./.github/workflows/flow-macos.yml
    secrets: inherit
    with:
      test-config: CONFIG=${{ matrix.test-config }}
      standalone: ${{ matrix.standalone }}
      coordinator: ${{ matrix.coordinator }}

  coverage:
    uses: ./.github/workflows/flow-coverage.yml
    secrets: inherit

  sanitize:
    uses: ./.github/workflows/flow-sanitizer.yml
    secrets: inherit
    with:
      flow-config: '' # full sanitization
