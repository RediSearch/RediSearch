language: c
compiler: gcc
dist: trusty

env:
  global:
    - MODULE_NAME=redisearch
    - REDIS_MODULE_PATH=$TRAVIS_BUILD_DIR/src/module.so
    - REDIS_PATH=$TRAVIS_BUILD_DIR/redis/src/redis-server

install:
  - make clean && make

before_script:
  - git clone --depth 1 https://github.com/antirez/redis.git
  - cd redis
  - make
  - cd ..
  - pip install redis rmtest ramp-packer mkdocs mkdocs-material

script:
  - make test

before_deploy:
  - make package
  - make docs

deploy:
  # Module latest artifact
  - provider: s3
    access_key_id: $AWS_ACCESS_KEY
    secret_access_key: $AWS_SECRET
    skip_cleanup: true
    acl: public_read
    bucket: redismodules
    upload-dir: $MODULE_NAME
    on:
      branch: master
    local_dir: $TRAVIS_BUILD_DIR/build
  # Website deployment
  - provider: s3
    access_key_id: $AWS_ACCESS_KEY
    secret_access_key: $AWS_SECRET
    skip_cleanup: true
    acl: public_read
    bucket: $MODULE_NAME.io
    on:
      branch: master
    local_dir: $TRAVIS_BUILD_DIR/site